# Multi-Stage Dockerfile for mcp-open-webresearch (Test Environment)
#
# Purpose: Test-ready image compatible with Node v24 LTS.
# - Based on the production Alpine image structure but retains dev deps/tools needed for testing.

# Stage 1: Builder - Full Node for deps and build
FROM node:24-alpine AS builder

RUN apk add --no-cache openssl
WORKDIR /app

# Copy package files for caching
COPY package*.json ./
# Install all deps (incl. dev) for build AND testing
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=true
# Ignore scripts to prevent postinstall running before source copy
RUN npm ci --ignore-scripts && npm cache clean --force

# Copy source and build TS to JS
COPY . .
# Now run postinstall (build + generate-certs)
RUN npm run postinstall

# Stage 2: Test Runtime - Alpine Node with ALL deps (including dev) and Chromium
FROM node:24-alpine

WORKDIR /app

# Install essential runtime deps
RUN apk add --no-cache \
    bash \
    ca-certificates \
    tini \
    gosu \
    libxkbcommon \
    gtk+3.0 \
    nss-tools \
    runit \
    udev \
    chromium \
    mitmproxy \
    openssl \
    curl \
    && rm -rf /var/cache/apk/* /tmp/* /var/tmp/* /usr/local/share/.cache /root/.npm /root/.cache

# Create cert dirs
RUN mkdir -p /usr/local/share/ca-certificates/host_certs

# Rebuild to run dependency lifecycle scripts (ignored during npm ci) and run project postinstall
# RUN npm run postinstall

# Copy built code and ALL node_modules (including dev deps for testing)
COPY --from=builder /app/build ./build
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/src ./src
COPY --from=builder /app/tsconfig.json ./tsconfig.json
COPY --from=builder /app/certs ./certs

# Copy launcher
COPY --from=builder /app/docker_launcher_test.sh ./launcher_test.sh

ENV PLAYWRIGHT_BROWSERS_PATH=0
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=true
ENV PLAYWRIGHT_BROWSERS_PATH=0
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=true
ENV NODE_ENV=test
ENV CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium

# Chown app, certs dirs to non-root user
RUN chown -R node:node /app /home/node

# Set tini as the init system
ENTRYPOINT ["/sbin/tini", "--"]

# Expose port (if needed for debugging, though tests run internally)
EXPOSE 3000

# Default command runs the tests
CMD ["./launcher_test.sh", "npm", "test"]
